{"version":3,"sources":["components/InViewFetcher.tsx","api/files.ts","pages/Media/index.tsx"],"names":["InViewFetcher","fetcher","onValue","limit","onError","React","useState","endReached","setEndReached","className","onChange","inView","a","res","error","length","size","uploadFileToStorage","file","Promise","resolve","reject","storage","firebase","metadata","contentType","type","fileName","v4","mime","extension","uploadTask","ref","put","on","snapshot","message","getDownloadURL","then","downloadUrl","uploadFile","fileDetails","name","url","storagePath","user","store","getState","token","fetch","window","location","origin","method","body","JSON","stringify","headers","Authorization","x","json","getFiles","orderBy","startAt","startAfter","deleteFile","docId","formatBytes","b","c","d","Math","floor","log","parseFloat","pow","toFixed","Media","uploadRef","useRef","assets","setAssets","notify","useNotify","useEffect","dispatch","payload","console","multiple","e","files","target","uploaded","variant","prev","noMinWidth","onClick","current","click","map","i","open","fontSize","confirm","confirmation","arr","splice","style","paddingTop","backgroundImage","split","slice","pop","results","uploaded_at"],"mappings":"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","file":"static/js/14.f98fe0e7.chunk.js","sourcesContent":["import Loader from \"components/Loader\";\r\nimport { InView } from \"react-intersection-observer\";\r\nimport React from \"react\";\r\n\r\nexport interface InViewFetcherProps {\r\n  fetcher: () => Promise<Array<any> | { error: any }>;\r\n  onValue: (a: Array<any>) => void;\r\n  onError?: (val: string) => void;\r\n  limit: number;\r\n}\r\n\r\nconst InViewFetcher: React.FC<InViewFetcherProps> = ({\r\n  fetcher,\r\n  onValue,\r\n  limit,\r\n  onError = () => {},\r\n}) => {\r\n  const [endReached, setEndReached] = React.useState(false);\r\n  return (\r\n    <InView\r\n      className=\"w-full\"\r\n      onChange={async (inView) => {\r\n        if (inView && !endReached) {\r\n          let res = await fetcher();\r\n          if (!(\"error\" in res)) {\r\n            onValue(res);\r\n            if (!res.length || res.length < limit) {\r\n              setEndReached(true);\r\n            }\r\n          } else {\r\n            onError(res.error);\r\n            setEndReached(true);\r\n          }\r\n        }\r\n      }}\r\n    >\r\n      {!endReached ? (\r\n        <div className=\"flex justify-center py-3\">\r\n          <Loader size=\"small\"></Loader>\r\n        </div>\r\n      ) : (\r\n        \"\"\r\n      )}\r\n    </InView>\r\n  );\r\n};\r\n\r\nexport default InViewFetcher;\r\n","import firebase from \"firebase\";\r\nimport store from \"store\";\r\nimport { v4 } from \"uuid\";\r\nimport mime from \"mime-types\";\r\n\r\nexport const uploadFileToStorage = (\r\n  file: File\r\n): Promise<{ downloadUrl: string; fileName: string } | { error: string }> => {\r\n  return new Promise((resolve, reject) => {\r\n    try {\r\n      const storage = firebase.storage();\r\n\r\n      const metadata = {\r\n        contentType: file.type,\r\n      };\r\n\r\n      const fileName = v4() + \".\" + mime.extension(file.type);\r\n      let ref = storage.ref(fileName);\r\n      const uploadTask = ref.put(file, metadata);\r\n      uploadTask.on(\r\n        \"state_changed\",\r\n        (snapshot) => {},\r\n        (error) => {\r\n          resolve({ error: error.message });\r\n        },\r\n        () => {\r\n          uploadTask.snapshot.ref.getDownloadURL().then((downloadUrl) => {\r\n            resolve({ downloadUrl, fileName });\r\n          });\r\n        }\r\n      );\r\n    } catch (error: any) {\r\n      resolve({ error });\r\n    }\r\n  });\r\n};\r\n\r\nexport const uploadFile = async (file: File): Promise<{ error: string } | any> => {\r\n  try {\r\n    const res = await uploadFileToStorage(file);\r\n    if (\"error\" in res) {\r\n      return res;\r\n    } else {\r\n      const fileDetails = {\r\n        name: file.name,\r\n        size: file.size,\r\n        url: res.downloadUrl,\r\n        storagePath: res.fileName,\r\n      };\r\n      const user = store.getState().user;\r\n      const token = user ? user.token : null;\r\n      return fetch(window.location.origin + \"/private/files\", {\r\n        method: \"POST\",\r\n        body: JSON.stringify(fileDetails),\r\n        headers: { Authorization: \"Bearer \" + token },\r\n      }).then((x) => x.json());\r\n    }\r\n  } catch (error) {\r\n    return { error };\r\n  }\r\n};\r\n\r\nexport type FileDocument = {\r\n  docId: string;\r\n  name: string;\r\n  size: number;\r\n  storagePath: string;\r\n  uploaded_at: number;\r\n  url: string;\r\n};\r\n\r\nexport const getFiles = async ({\r\n  limit = 10,\r\n  orderBy,\r\n  startAt,\r\n  startAfter,\r\n}: {\r\n  limit?: number;\r\n  orderBy: string;\r\n  startAt?: string | number;\r\n  startAfter?: string | number;\r\n}): Promise<Array<FileDocument> | { error: string }> => {\r\n  try {\r\n    const user = store.getState().user;\r\n    const token = user ? user.token : null;\r\n    return fetch(\r\n      window.location.origin +\r\n        `/private/files?limit=${limit}${\r\n          startAt ? \"&startAt=\" + startAt : \"\"\r\n        }&orderBy=${orderBy},desc${startAfter ? `&startAfter=${startAfter}` : \"\"}`,\r\n      {\r\n        headers: { Authorization: \"Bearer \" + token },\r\n      }\r\n    ).then((x) => x.json());\r\n  } catch (error: any) {\r\n    return { error };\r\n  }\r\n};\r\n\r\nexport const getFilesCount = async () => {\r\n  try {\r\n    const user = store.getState().user;\r\n    const token = user ? user.token : null;\r\n    return fetch(window.location.origin + `/private/files/count`, {\r\n      headers: { Authorization: \"Bearer \" + token },\r\n    }).then((x) => x.json());\r\n  } catch (error) {\r\n    return { error };\r\n  }\r\n};\r\n\r\nexport const deleteFile = (docId: string, storagePath: string) => {\r\n  try {\r\n    const user = store.getState().user;\r\n    const token = user ? user.token : null;\r\n    return fetch(window.location.origin + `/private/files`, {\r\n      method: \"DELETE\",\r\n      headers: { Authorization: \"Bearer \" + token },\r\n      body: JSON.stringify({ docId, storagePath }),\r\n    }).then((x) => x.json());\r\n  } catch (error) {\r\n    return { error };\r\n  }\r\n};\r\n","import Button from \"components/Button\";\r\nimport { IoAdd } from \"react-icons/io5\";\r\nimport React from \"react\";\r\nimport { uploadFile, getFiles, FileDocument, deleteFile } from \"api/files\";\r\nimport store from \"store\";\r\nimport InViewFetcher from \"components/InViewFetcher\";\r\nimport ButtonBase from \"@material-ui/core/ButtonBase\";\r\nimport OpenInNew from \"@material-ui/icons/OpenInNew\";\r\nimport DeleteIcon from \"@material-ui/icons/Delete\";\r\nimport { confirm } from \"components/Confirm\";\r\nimport { useNotify } from \"components/NotificationsProvider\";\r\n\r\nexport function formatBytes(a: number, b = 2) {\r\n  if (0 === a) return \"0 Bytes\";\r\n  const c = 0 > b ? 0 : b,\r\n    d = Math.floor(Math.log(a) / Math.log(1024));\r\n  return (\r\n    parseFloat((a / Math.pow(1024, d)).toFixed(c)) +\r\n    \" \" +\r\n    [\"Bytes\", \"KB\", \"MB\", \"GB\", \"TB\", \"PB\", \"EB\", \"ZB\", \"YB\"][d]\r\n  );\r\n}\r\n\r\nexport interface MediaProps {}\r\n\r\nconst Media: React.FC<MediaProps> = () => {\r\n  const uploadRef = React.useRef(null as any);\r\n  const [assets, setAssets] = React.useState<Array<FileDocument>>([]);\r\n  const notify = useNotify();\r\n\r\n  React.useEffect(() => {\r\n    (async () => {\r\n      try {\r\n        store.dispatch({ type: \"SET_LOADING\", payload: true });\r\n        const res = await getFiles({ orderBy: \"uploaded_at\" });\r\n        if (\"error\" in res) {\r\n        } else {\r\n          setAssets(res);\r\n        }\r\n\r\n        store.dispatch({ type: \"SET_LOADING\", payload: false });\r\n      } catch (er) {\r\n        console.log(er);\r\n      }\r\n    })();\r\n  }, []);\r\n  return (\r\n    <div>\r\n      <div className=\"flex justify-between flex-wrap mb-7\">\r\n        <div className=\"font-medium text-36px leading-none mb-4 mr-4\">Media</div>\r\n        <input\r\n          type=\"file\"\r\n          multiple\r\n          className=\"hidden\"\r\n          ref={uploadRef}\r\n          onChange={async (e) => {\r\n            const files = e.target.files;\r\n            if (files && files.length) {\r\n              store.dispatch({\r\n                type: \"SET_LOADING\",\r\n                payload: `Uploading ${files.length} file${files.length > 1 ? \"s\" : \"\"}...`,\r\n              });\r\n              let uploaded = 0;\r\n              for (let file of files) {\r\n                const res = await uploadFile(file);\r\n                if (!(\"error\" in res)) {\r\n                  uploaded++;\r\n                  store.dispatch({\r\n                    type: \"SET_LOADING\",\r\n                    payload: `${uploaded}/${files.length} uploaded.`,\r\n                  });\r\n                  setAssets((prev) => [res, ...prev]);\r\n                } else {\r\n                  notify(\"Permission denied\", { variant: \"error\" });\r\n                }\r\n              }\r\n\r\n              store.dispatch({ type: \"SET_LOADING\", payload: false });\r\n            }\r\n          }}\r\n        />\r\n        <Button\r\n          noMinWidth\r\n          onClick={() => uploadRef.current.click()}\r\n          className=\"bg-orange-300 hover:bg-orange-301 mb-4\"\r\n        >\r\n          <div className=\"flex items-center\">\r\n            <IoAdd className=\"mr-2\" size={18}></IoAdd>\r\n            <span>Upload</span>\r\n          </div>\r\n        </Button>\r\n      </div>\r\n      {/* <div className=\"mb-6 text-gray-600 leading-none\">{count} files in total</div> */}\r\n      <div className=\"flex flex-wrap -mx-3\">\r\n        {assets.map((x, i) => (\r\n          <div key={`asset-${i}`} className=\"xl:w-3/12 lg:w-4/12 xs:w-6/12 w-full px-3 mb-6\">\r\n            <div className=\"w-full relative rounded-sm overflow-hidden group\">\r\n              <div className=\"absolute top-0 left-0 justify-between p-3 w-full z-20 group-hover:opacity-100 opacity-0 transition duration-200 flex\">\r\n                <ButtonBase\r\n                  onClick={() => window.open(x.url, \"_blank\")}\r\n                  className=\"outline-none h-26px w-26px rounded bg-orange-300 hover:bg-orange-301\"\r\n                >\r\n                  <OpenInNew fontSize=\"small\"></OpenInNew>\r\n                </ButtonBase>\r\n                <ButtonBase className=\"outline-none h-26px w-26px rounded bg-orange-300 hover:bg-orange-301\">\r\n                  <DeleteIcon\r\n                    fontSize=\"small\"\r\n                    onClick={async () => {\r\n                      if (\r\n                        await confirm({\r\n                          confirmation: \"Do you really want to delete this file?\",\r\n                        })\r\n                      ) {\r\n                        setAssets((prev) => {\r\n                          let arr = [...prev];\r\n                          arr.splice(i, 1);\r\n                          return arr;\r\n                        });\r\n                        const res = await deleteFile(x.docId, x.storagePath);\r\n                        if (!(\"error\" in res)) {\r\n                          notify(\"File deleted!\", { variant: \"success\" });\r\n                        }\r\n                      }\r\n                    }}\r\n                  ></DeleteIcon>\r\n                </ButtonBase>\r\n              </div>\r\n\r\n              <div style={{ paddingTop: \"61%\" }} className=\"bg-blue-300\"></div>\r\n              <div\r\n                style={{ paddingTop: \"61%\", backgroundImage: `url(${x.url})` }}\r\n                className=\"bg-center bg-contain bg-no-repeat absolute left-0 top-0 z-10 w-full\"\r\n              ></div>\r\n\r\n              <div className=\"p-4 bg-gray-300\">\r\n                <div className=\"line-clamp-1 font-medium mb-3\">{x.name}</div>\r\n                <div className=\"flex justify-between\">\r\n                  <div>{formatBytes(x.size)}</div>\r\n                  <div>\r\n                    <div className=\"bg-orange-300 rounded px-2 py-0.5 text-sm\">\r\n                      {x.name.split(\".\").slice(-1).pop()}\r\n                    </div>\r\n                  </div>\r\n                </div>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        ))}\r\n        {assets.length ? (\r\n          <InViewFetcher\r\n            limit={10}\r\n            onValue={(results: Array<FileDocument>) => {\r\n              setAssets((prev) => [...prev, ...results]);\r\n            }}\r\n            fetcher={() =>\r\n              getFiles({\r\n                startAfter: assets[assets.length - 1].uploaded_at,\r\n                orderBy: \"uploaded_at\",\r\n              })\r\n            }\r\n          ></InViewFetcher>\r\n        ) : null}\r\n      </div>\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default Media;\r\n"],"sourceRoot":""}